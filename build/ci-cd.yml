# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: 'BUILD'
  jobs:
  - job:
    displayName: 'Package up scripts'
    steps:
    - task: CopyFiles@2
      displayName: "Copy ARM templates"
      inputs:
        SourceFolder: '/$(Build.SourcesDirectory)/infra'
        Contents: '*.json'
        TargetFolder: '/$(Build.ArtifactStagingDirectory)/infra'
    - task: CopyFiles@2
      displayName: "Copy documentation files"
      inputs:
        SourceFolder: '/$(Build.SourcesDirectory)/docs'
        Contents: '*.json'
        TargetFolder: '/$(Build.ArtifactStagingDirectory)/docs'
    - task: PublishBuildArtifacts@1
      displayName: "Publish package to Azure DevOps artifacts repo"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

- stage: 'DEV'
  jobs:
  - job:
    displayName: 'Deploy resources'
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(serviceconnection)'
        subscriptionId: '$(subscriptionid)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: 'jvw-coreapp-demo-dev'
        location: 'West Europe'
        templateLocation: 'Linked artifact'
        csmFile: '$(System.ArtifactsDirectory)/drop/infra/azure-resources.json'
        csmParametersFile: '$(System.ArtifactsDirectory)/drop/infra/resource-parameters.dev.json'
        deploymentMode: 'Complete'
        overrideParameters: ''
        deploymentOutputs: 'arm-outputs'
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          # Write your commands here
          sed -i "s/##OUTPUT_VARIABLES##/$(arm-outputs)/g" $(System.ArtifactsDirectory)/drop/docs/build-summary.md
          ##vso[task.uploadsummary]$(System.ArtifactsDirectory)/drop/docs/build-summary.md
- stage: 'TEST'
  jobs:
  - job:
    displayName: 'Deploy resources'
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(serviceconnection)'
        subscriptionId: '$(subscriptionid)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: 'jvw-coreapp-demo-test'
        location: 'West Europe'
        templateLocation: 'Linked artifact'
        csmFile: '$(System.ArtifactsDirectory)/drop/infra/azure-resources.json'
        csmParametersFile: '$(System.ArtifactsDirectory)/drop/infra/resource-parameters.test.json'
        deploymentMode: 'Complete'